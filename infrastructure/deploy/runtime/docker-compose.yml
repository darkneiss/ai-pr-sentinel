services:
  api:
    image: ${API_IMAGE:?Set API_IMAGE in .env}
    container_name: ai-pr-sentinel-api
    restart: unless-stopped
    env_file:
      - ./.env
    expose:
      - "${API_PORT:-3000}"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:${API_PORT:-3000}/health >/dev/null"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - edge
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

  nginx:
    image: nginx:1.27.5-alpine
    container_name: ai-pr-sentinel-nginx
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
      certbot-init:
        condition: service_completed_successfully
    environment:
      SERVER_NAME: ${SERVER_NAME:?Set SERVER_NAME in .env}
      API_UPSTREAM_HOST: api
      API_UPSTREAM_PORT: "${API_PORT:-3000}"
      NGINX_TLS_ENABLED: "${NGINX_TLS_ENABLED:-true}"
      NGINX_CLIENT_MAX_BODY_SIZE: "${NGINX_CLIENT_MAX_BODY_SIZE:-100m}"
      NGINX_KEEPALIVE_TIMEOUT: "${NGINX_KEEPALIVE_TIMEOUT:-5s}"
      NGINX_CLIENT_BODY_TIMEOUT: "${NGINX_CLIENT_BODY_TIMEOUT:-10s}"
      NGINX_CLIENT_HEADER_TIMEOUT: "${NGINX_CLIENT_HEADER_TIMEOUT:-10s}"
      NGINX_SEND_TIMEOUT: "${NGINX_SEND_TIMEOUT:-10s}"
      NGINX_PROXY_READ_TIMEOUT: "${NGINX_PROXY_READ_TIMEOUT:-300s}"
      NGINX_PROXY_SEND_TIMEOUT: "${NGINX_PROXY_SEND_TIMEOUT:-300s}"
      NGINX_ROBOTS_TAG: "${NGINX_ROBOTS_TAG:-noindex, nofollow, noarchive}"
      NGINX_CERT_RELOAD_INTERVAL_SECONDS: "${NGINX_CERT_RELOAD_INTERVAL_SECONDS:-300}"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/entrypoint/40-render-site-config.sh:/docker-entrypoint.d/40-render-site-config.sh:ro
      - ./nginx/entrypoint/50-reload-on-cert-change.sh:/docker-entrypoint.d/50-reload-on-cert-change.sh:ro
      - ./nginx/templates:/opt/nginx/templates:ro
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - edge
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

  certbot-init:
    image: certbot/certbot:v2.11.0
    container_name: ai-pr-sentinel-certbot-init
    environment:
      SERVER_NAME: ${SERVER_NAME:?Set SERVER_NAME in .env}
      LETSENCRYPT_EMAIL: "${LETSENCRYPT_EMAIL:-}"
      NGINX_TLS_ENABLED: "${NGINX_TLS_ENABLED:-true}"
      CERTBOT_STAGING: "${CERTBOT_STAGING:-false}"
    ports:
      - "80:80"
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    entrypoint: ["/bin/sh", "-ec"]
    command:
      - |
        if [ "$${NGINX_TLS_ENABLED}" != "true" ]; then
          echo "NGINX_TLS_ENABLED=false. Skipping initial certificate issuance."
          exit 0
        fi

        if [ -z "$${LETSENCRYPT_EMAIL}" ]; then
          echo "LETSENCRYPT_EMAIL is required when NGINX_TLS_ENABLED=true." >&2
          exit 1
        fi

        CERT_PATH="/etc/letsencrypt/live/$${SERVER_NAME}/fullchain.pem"
        KEY_PATH="/etc/letsencrypt/live/$${SERVER_NAME}/privkey.pem"

        if [ -f "$${CERT_PATH}" ] && [ -f "$${KEY_PATH}" ]; then
          echo "Existing certificate found for $${SERVER_NAME}. Skipping initial issuance."
          exit 0
        fi

        STAGING_FLAG=""
        if [ "$${CERTBOT_STAGING}" = "true" ]; then
          STAGING_FLAG="--staging"
          echo "Using Let's Encrypt staging environment for initial issuance."
        fi

        certbot certonly \
          --standalone \
          --preferred-challenges http \
          --http-01-port 80 \
          --email "$${LETSENCRYPT_EMAIL}" \
          --agree-tos \
          --no-eff-email \
          --non-interactive \
          $${STAGING_FLAG} \
          -d "$${SERVER_NAME}"

  certbot-renew:
    image: certbot/certbot:v2.11.0
    container_name: ai-pr-sentinel-certbot-renew
    restart: unless-stopped
    depends_on:
      nginx:
        condition: service_started
    environment:
      NGINX_TLS_ENABLED: "${NGINX_TLS_ENABLED:-true}"
      CERTBOT_RENEW_INTERVAL_SECONDS: "${CERTBOT_RENEW_INTERVAL_SECONDS:-43200}"
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    entrypoint: ["/bin/sh", "-ec"]
    command:
      - |
        if [ "$${NGINX_TLS_ENABLED}" != "true" ]; then
          echo "NGINX_TLS_ENABLED=false. Automatic renewal loop disabled."
          exec sleep infinity
        fi

        while :; do
          certbot renew --webroot -w /var/www/certbot --non-interactive --quiet || true
          sleep "$${CERTBOT_RENEW_INTERVAL_SECONDS}"
        done

  certbot:
    image: certbot/certbot:v2.11.0
    container_name: ai-pr-sentinel-certbot
    profiles: ["ops"]
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    entrypoint: ["certbot"]

networks:
  edge:
    name: ai-pr-sentinel-edge
    driver: bridge
